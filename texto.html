<script>
let recog, escuchando=false, texto="di una palabra", particles=[], pg;
const NP=1200, gap=6, tam=160;
const $btn=document.getElementById('btn'), $msg=document.getElementById('msg');
const log=m=>{$msg.textContent=m; console.log(m);};

function setup(){
  const c=createCanvas(windowWidth, windowHeight);
  pg=createGraphics(width,height);
  background(0);
  generarParticulasDesdeTexto(texto);
  initSpeech();
}
function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
  pg=createGraphics(width,height);
  generarParticulasDesdeTexto(texto);
}

function initSpeech(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ log("Web Speech API no disponible."); return; }
  recog=new SR();
  recog.lang="es-ES";          // probá "es-AR" si querés
  recog.interimResults=true;    // ← en vivo
  recog.continuous=true;
  recog.maxAlternatives=1;

  recog.onstart=()=>log("Escuchando…");
  recog.onaudiostart=()=>console.log("audio start");
  recog.onspeechstart=()=>console.log("speech start");
  recog.onspeechend=()=>console.log("speech end");
  recog.onend=()=>{ console.log("end"); if(escuchando){ try{recog.start();}catch(_){} } };

  recog.onresult=e=>{
    const i = e.resultIndex;          // ← clave: usar el índice del evento
    const res = e.results[i];
    if(!res || !res[0]) return;
    const txt = res[0].transcript.trim();
    if(!txt) return;
    texto = txt.toUpperCase();
    generarParticulasDesdeTexto(texto);
    log((res.isFinal ? "Final: " : "Interim: ")+txt+"  (conf "+res[0].confidence.toFixed(2)+")");
  };

  recog.onerror=e=>{
    log("Error: "+e.error);
    // reintentos básicos
    if(["no-speech","audio-capture","network"].includes(e.error)){
      try{ recog.stop(); }catch(_){}
      setTimeout(()=>{ if(escuchando) try{recog.start();}catch(_){ } }, 600);
    }
  };
}

$btn.onclick=()=>{
  if(!recog){ log("Usa Chrome en https."); return; }
  if(!escuchando){
    try{ recog.abort?.(); }catch(_){}
    try{ recog.start(); escuchando=true; $btn.textContent="Detener"; }
    catch(err){ log("No pude iniciar: "+err.message); }
  }else{
    escuchando=false; try{recog.stop();}catch(_){}
    $btn.textContent="Iniciar"; log("Detenido.");
  }
};

function generarParticulasDesdeTexto(t){
  pg.clear(); pg.pixelDensity(1);
  pg.push(); pg.background(0,0); pg.textAlign(CENTER,CENTER);
  pg.textSize(tam); pg.textStyle(BOLD); pg.fill(255); pg.noStroke();
  pg.translate(width/2,height/2); pg.text(t,0,0); pg.pop(); pg.loadPixels();

  const targets=[];
  for(let y=0;y<height;y+=gap){
    for(let x=0;x<width;x+=gap){
      const i=4*(y*width+x);
      if(pg.pixels[i+3]>128) targets.push(createVector(x,y));
    }
  }
  const total=min(NP,targets.length);
  while(particles.length<total) particles.push(nuevaParticula(random(width),random(height)));
  if(particles.length>total) particles.length=total;
  shuffle(targets,true);
  for(let i=0;i<particles.length;i++) particles[i].target=targets[i].copy();
}

function nuevaParticula(x,y){
  return {pos:createVector(x,y), vel:p5.Vector.random2D().mult(random(2)),
    acc:createVector(0,0), target:createVector(x,y), maxSpeed:8, maxForce:0.6, r:2+random(1.5)};
}

function draw(){
  background(0,40);
  const t=millis()*0.0004;
  noStroke();
  for(const p of particles){
    const desired=p5.Vector.sub(p.target,p.pos), d=desired.mag();
    desired.setMag(d<60?map(d,0,60,0,p.maxSpeed):p.maxSpeed);
    const steer=p5.Vector.sub(desired,p.vel).limit(p.maxForce);
    const n=noise(p.pos.x*0.005,p.pos.y*0.005,t);
    const flow=p5.Vector.fromAngle(map(n,0,1,-PI,PI)).mult(0.15);
    p.acc.set(0,0); p.acc.add(steer).add(flow);
    p.vel.add(p.acc).limit(p.maxSpeed);
    p.pos.add(p.vel);
    fill(255, constrain(map(d,0,120,255,40),40,255));
    circle(p.pos.x,p.pos.y,p.r);
  }
}
</script>
