<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voz → Partículas</title>
<style>
  html,body{margin:0;height:100%;background:#000;overflow:hidden}
  canvas.p5Canvas{position:fixed;inset:0;display:block;z-index:0}
  /* hint centrado, se quita al iniciar */
  #tap{position:fixed;inset:0;display:grid;place-items:center;z-index:9999;
       color:#9cf;font:600 14px/1.4 system-ui,Segoe UI,Roboto,sans-serif}
  #tap.hide{display:none}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.3/p5.min.js"></script>
</head>
<body>
<div id="tap">clic para activar micrófono</div>
<script>
/* ===== Limpia overlays viejos por si quedaron del cache ===== */
["#ui","#msg","#out"].forEach(sel=>{
  const el=document.querySelector(sel); if(el) el.remove();
});

/* ===== Config ===== */
const LENGUAJE = "es-ES";   // "es-AR" si preferís
const TAM_TEXTO = 180;
const MUESTRA   = 6;
const N_PARTIC  = 1200;

/* ===== Estado ===== */
let recog, escuchando=false, texto="DI UNA PALABRA";
let particles=[], pg;

function setup(){
  createCanvas(windowWidth, windowHeight).addClass('p5Canvas');
  pixelDensity(1);
  pg = createGraphics(width, height); pg.pixelDensity(1);
  background(0);
  generarParticulasDesdeTexto(texto);
  initSpeech();

  // gesto del usuario para iniciar el micrófono
  const tap = document.getElementById('tap');
  const arrancar = ()=>{
    if(recog && !escuchando){
      try{ recog.start(); escuchando=true; tap.classList.add('hide'); }catch(_){}
    } else { tap.classList.add('hide'); }
  };
  window.addEventListener('pointerdown', arrancar, {once:true});
  window.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' '){arrancar();}}, {once:true});
}

function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
  pg = createGraphics(width, height); pg.pixelDensity(1);
  generarParticulasDesdeTexto(texto);
}

/* ===== Voz ===== */
function initSpeech(){
  const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
  if(!SR) return;
  recog = new SR();
  recog.lang = LENGUAJE;
  recog.interimResults = false; // solo finales
  recog.continuous = true;
  recog.maxAlternatives = 1;

  recog.onresult = e=>{
    const r = e.results[e.resultIndex];
    if(!r || !r[0]) return;
    const txt = r[0].transcript.trim();
    if(!txt) return;
    texto = txt.toUpperCase();
    generarParticulasDesdeTexto(texto);
  };
  recog.onend = ()=>{ if(escuchando){ try{recog.start();}catch(_){}} };
}

/* ===== Partículas ===== */
function generarParticulasDesdeTexto(t){
  pg.clear();
  pg.push();
  pg.textAlign(CENTER, CENTER);
  pg.textSize(TAM_TEXTO);
  pg.textStyle(BOLD);
  pg.fill(255); pg.noStroke();
  pg.translate(width/2, height/2);
  pg.text(t, 0, 0);
  pg.pop();
  pg.loadPixels();

  const targets=[];
  for(let y=0; y<height; y+=MUESTRA){
    for(let x=0; x<width; x+=MUESTRA){
      const i = 4*(y*width + x);
      if(pg.pixels[i+3] > 128) targets.push(createVector(x,y));
    }
  }
  const total = min(N_PARTIC, targets.length);
  while(particles.length < total) particles.push(nuevaParticula(random(width), random(height)));
  if(particles.length > total) particles.length = total;

  shuffle(targets, true);
  for(let i=0; i<particles.length; i++) particles[i].target = targets[i].copy();
}

function nuevaParticula(x,y){
  return {
    pos: createVector(x,y),
    vel: p5.Vector.random2D().mult(random(2)),
    acc: createVector(0,0),
    target: createVector(x,y),
    maxSpeed: 8,
    maxForce: 0.6,
    r: 2 + random(1.5)
  };
}

function draw(){
  background(0, 40);
  noStroke();
  const t = millis()*0.0004;
  for(const p of particles){
    const desired = p5.Vector.sub(p.target, p.pos);
    const d = desired.mag();
    desired.setMag(d<60 ? map(d,0,60,0,p.maxSpeed) : p.maxSpeed);
    const steer = p5.Vector.sub(desired, p.vel).limit(p.maxForce);
    const n = noise(p.pos.x*0.005, p.pos.y*0.005, t);
    const flow = p5.Vector.fromAngle(map(n,0,1,-PI,PI)).mult(0.15);
    p.acc.set(0,0);
    p.acc.add(steer).add(flow);
    p.vel.add(p.acc).limit(p.maxSpeed);
    p.pos.add(p.vel);
    fill(255, constrain(map(d,0,120,255,40), 40, 255));
    circle(p.pos.x, p.pos.y, p.r);
  }
}
</script>
</body>
</html>
