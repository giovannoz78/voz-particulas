<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voz → Partículas</title>
<style>
  body{margin:0;background:#000}
  button{position:fixed;left:16px;top:16px;z-index:10;padding:8px 12px}
  #msg{position:fixed;left:16px;top:56px;z-index:10;color:#9cf;font:12px/1.4 monospace}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.3/p5.min.js"></script>
</head>
<body>
<button id="btn">Iniciar</button>
<div id="msg">Permite micrófono y haz clic “Iniciar”.</div>

<script>
let recog, escuchando=false, texto="di una palabra", particles=[], pg;
const NP=1200, gap=6, tam=160;
const $btn=document.getElementById('btn'), $msg=document.getElementById('msg');
const log=m=>{$msg.textContent=m; console.log(m);};

function setup(){
  createCanvas(windowWidth, windowHeight);
  pg=createGraphics(width,height);
  background(0);
  generarParticulasDesdeTexto(texto);
  initSpeech();
}
function windowResized(){
  resizeCanvas(windowWidth, windowHeight);
  pg=createGraphics(width,height);
  generarParticulasDesdeTexto(texto);
}

function initSpeech(){
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  if(!SR){ log("Web Speech API no disponible."); return; }
  recog=new SR();
  recog.lang="es-AR";          // o "es-ES"
  recog.interimResults=false;
  recog.continuous=true;

  recog.onresult=e=>{
    const r=e.results[e.results.length-1][0].transcript.trim();
    if(r){ texto=r.toUpperCase(); generarParticulasDesdeTexto(texto); log("Escuché: "+r); }
  };
  recog.onerror=e=>log("Error: "+e.error);
  recog.onend=()=>{ if(escuchando){ try{recog.start();}catch(_){} } };
}

$btn.onclick=()=>{
  if(!recog){ log("Sin SpeechRecognition (usa Chrome en https)."); return; }
  if(!escuchando){
    try{ recog.start(); escuchando=true; $btn.textContent="Detener"; log("Escuchando…"); }
    catch(err){ log("No pude iniciar: "+err.message); }
  }else{
    escuchando=false; try{recog.stop();}catch(_){}
    $btn.textContent="Iniciar"; log("Detenido.");
  }
};

function generarParticulasDesdeTexto(t){
  pg.clear(); pg.pixelDensity(1);
  pg.push(); pg.background(0,0); pg.textAlign(CENTER,CENTER);
  pg.textSize(tam); pg.textStyle(BOLD); pg.fill(255); pg.noStroke();
  pg.translate(width/2,height/2); pg.text(t,0,0); pg.pop(); pg.loadPixels();

  const targets=[];
  for(let y=0;y<height;y+=gap){
    for(let x=0;x<width;x+=gap){
      const i=4*(y*width+x);
      if(pg.pixels[i+3]>128) targets.push(createVector(x,y));
    }
  }
  const total=min(NP,targets.length);
  while(particles.length<total) particles.push(nuevaParticula(random(width),random(height)));
  if(particles.length>total) particles.length=total;
  shuffle(targets,true);
  for(let i=0;i<particles.length;i++) particles[i].target=targets[i].copy();
}

function nuevaParticula(x,y){
  return {pos:createVector(x,y), vel:p5.Vector.random2D().mult(random(2)),
    acc:createVector(0,0), target:createVector(x,y), maxSpeed:8, maxForce:0.6, r:2+random(1.5)};
}

function draw(){
  background(0,40);
  const t=millis()*0.0004;
  noStroke();
  for(const p of particles){
    const desired=p5.Vector.sub(p.target,p.pos), d=desired.mag();
    desired.setMag(d<60?map(d,0,60,0,p.maxSpeed):p.maxSpeed);
    const steer=p5.Vector.sub(desired,p.vel).limit(p.maxForce);
    const n=noise(p.pos.x*0.005,p.pos.y*0.005,t);
    const flow=p5.Vector.fromAngle(map(n,0,1,-PI,PI)).mult(0.15);
    p.acc.set(0,0); p.acc.add(steer).add(flow);
    p.vel.add(p.acc).limit(p.maxSpeed);
    p.pos.add(p.vel);
    fill(255, constrain(map(d,0,120,255,40),40,255));
    circle(p.pos.x,p.pos.y,p.r);
  }
}
</script>
</body>
</html>
